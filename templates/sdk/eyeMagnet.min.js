const offset={x:0,y:0};function createCalibrator(className,textContent){var calibrator=document.createElement("div");return calibrator.className=className,calibrator.textContent=textContent,calibrator}const latchCalibrator={};function checkCalibrator(class_name,check){return class_name in latchCalibrator||(latchCalibrator[class_name]=!1),latchCalibrator[class_name]||(check?(latchCalibrator[class_name]=check,latchCalibrator[class_name]):void 0)}function resetCalibrators(){for(const latchKey in latchCalibrator)latchCalibrator[latchKey]=!0}function setOffset(x,y){offset.x=x,offset.y=y}function create_instruction_box(name){var instruct_body=document.createElement("div"),instruction=(instruct_body.className="instruct_body",document.createElement("div")),arrow=(instruction.className="instruction",instruction.innerText="Look there",document.createElement("div"));arrow.className="arrow arrow_"+name,arrow.style.position="fixed";for(let i=0;i<3;i++)arrow.appendChild(document.createElement("span"));return instruct_body.appendChild(instruction),instruct_body.appendChild(arrow),instruct_body}function display_calibrator(name){var element=createCalibrator("calibrator calibrator_"+name+" message-"+name,"Move cursor here"),name=create_instruction_box(name),background=document.createElement("div");background.className="calibration_background",document.body.appendChild(name),document.body.appendChild(element),document.body.appendChild(background)}function remove_calibrator(name){name=document.getElementsByClassName("calibrator_"+name);0<name.length&&name[0].remove(),0<(name=document.getElementsByClassName("instruct_body")).length&&name[0].remove(),0<(name=document.getElementsByClassName("calibration_background")).length&&name[0].remove(),document.getElementsByClassName("calibration_background")}var calibration_counter=0,calibration_sequence=[],startTimestamp=Date.now();const MIN_TIME_WAIT=2e3;function calibrator(x,y,fix){if(calibration_counter>=calibration_sequence.length&&0<calibration_sequence.length)return!0;var side_horizontal,side_vertical,width=window.innerWidth||document.documentElement.clientWidth,height=window.innerHeight||document.documentElement.clientHeight,fix=.2<fix;0==calibration_sequence.length&&(console.log(x,width,side_horizontal),side_vertical=height/2<y,(side_horizontal=width/2<x)?(calibration_sequence.push("right"),calibration_sequence.push("left")):(calibration_sequence.push("left"),calibration_sequence.push("right")),side_vertical?(calibration_sequence.push("bottom"),calibration_sequence.push("top")):(calibration_sequence.push("top"),calibration_sequence.push("bottom")),display_calibrator(calibration_sequence[calibration_counter]));let ret_val=!1;return calibration_counter<=calibration_sequence.length&&("left"==calibration_sequence[calibration_counter]?ret_val=checkCalibrator(".calibrator_"+calibration_sequence[calibration_counter],x<=160&&fix&&Date.now()-startTimestamp>MIN_TIME_WAIT):"right"==calibration_sequence[calibration_counter]?ret_val=checkCalibrator(".calibrator_"+calibration_sequence[calibration_counter],width-160<=x&&fix&&Date.now()-startTimestamp>MIN_TIME_WAIT):"bottom"==calibration_sequence[calibration_counter]?ret_val=checkCalibrator(".calibrator_"+calibration_sequence[calibration_counter],height-160<=y&&fix&&Date.now()-startTimestamp>MIN_TIME_WAIT):"top"==calibration_sequence[calibration_counter]&&(ret_val=checkCalibrator(".calibrator_"+calibration_sequence[calibration_counter],y<=160&&fix&&Date.now()-startTimestamp>MIN_TIME_WAIT))),ret_val&&(remove_calibrator(calibration_sequence[calibration_counter]),calibration_counter+=1,startTimestamp=Date.now(),calibration_counter<calibration_sequence.length)&&display_calibrator(calibration_sequence[calibration_counter]),calibration_counter>=calibration_sequence.length}function checkCalibration(x,y,fix){var width=window.innerWidth||document.documentElement.clientWidth,height=window.innerHeight||document.documentElement.clientHeight,fix=.2<fix;return[checkCalibrator(".calibrator_left",x<=160&&fix),checkCalibrator(".calibrator_right",width-160<=x&&fix),checkCalibrator(".calibrator_top",y<=160&&fix),checkCalibrator(".calibrator_bottom",height-160<=y&&fix)]}function createVideoElement(){var video=document.createElement("video");return video.id="localVideo",video.width=360,video.height=240,video.autoplay=!0,video.muted=!0,video.hidden=!0,video.style.width="auto",video.style.height="auto",video}function createTransportCanvas(){return(trasnportCanvas=document.createElement("canvas")).width=640,trasnportCanvas.height=360,trasnportCanvas}function createSocket(){var addr="http://{{domain}}";return console.log("connecting to: "+addr),io.connect(addr)}function EyeGestureApi(API_KEY,thresh,radius,options={}){const{display_width=document.body.clientWidth-75,display_height=document.body.clientHeight-75,onFrame=function(video){},calibration=!0,DEBUG=!1}=options;var unique_id="{{unique_id}}";const video=createVideoElement(),trasnportCanvas=(document.body.appendChild(video),createTransportCanvas());var socket=createSocket();navigator.mediaDevices.getUserMedia({video:!0}).then(function(stream){calibration&&socket.emit("/api/startCalibration",{key:API_KEY,unique_id:unique_id}),function(video,stream){video.srcObject=stream,video.play()}(video,stream);setInterval(loop,1e3/15)}).catch(function(error){console.error("Error accessing the camera and microphone:",error)}),socket.on("/api/onConnect",function(){console.log("/api/onConnect"),document.body.style.maxWidth=document.body.clientWidth,document.body.style.maxHeight=document.body.clientHeight;var payload={key:API_KEY,width:display_width,height:display_height,unique_id:unique_id,thresh:thresh,radius:radius};socket.emit("/api/clientData",payload)});function loop(){var image;trasnportContext=trasnportCanvas.getContext("2d"),DEBUG?((image=new Image).src="/demo_pic/debug_face.jpg",trasnportContext.drawImage(image,0,0,trasnportCanvas.width,trasnportCanvas.height),onFrame(image)):(trasnportContext.drawImage(video,0,0,trasnportCanvas.width,trasnportCanvas.height),onFrame(video)),image=trasnportCanvas.toDataURL("image/jpeg",.8),socket.emit("/api/stream",{key:API_KEY,unique_id:unique_id,thresh:thresh,radius:radius,height:display_height,width:display_width,offset_x:offset.x,offset_y:offset.y,image:image,timestamp:Date.now()})}socket.on("/api/cursor",function(event){console.log("Data received to cursor")})}const magnetStrong=.7,magnetAssistanceRange=100,velocity_thresh=.4,currentElement={el:null,frame:0},dot={x:0,y:0,offset_x:0,offset_y:0,offset_ret_x:0,offset_ret_y:0,margin:50,angle:Math.random()*Math.PI*2,radius:20,speed:.005,history:[]};var eyeMagnetRun=!0;function EyeMagnetStop(){eyeMagnetRun=!1}function EyeMagnetStart(){eyeMagnetRun=!0}function EyeMagnetAPI(API_KEY,thresh,radius,options={}){const{onFrame=function(video){},onCursor=function(x,y,fix,blink){},onMagnet=function(element,fix,blink){},onCalibration=function(){},onWeakConnection=function(){},onMagnetCalibration=function(completed){},display_width=document.body.clientWidth-75,display_height=document.body.clientHeight-75,calibration_layout=!0,calibration=!0,DEBUG=!1}=options;function scanMagnet(center_x,center_y,margin){var StrongElements=document.getElementsByClassName("eyeMagnet"),element=null;return Array.prototype.forEach.call(StrongElements,function(el){!function(x,y,el,margin){el=el.getBoundingClientRect();var left=parseInt(el.left)-margin,topPos=parseInt(el.top)-margin,width=parseInt(el.width)+margin,el=parseInt(el.height)+margin;return parseFloat(x)>=left&&parseFloat(x)<=left+width&&parseFloat(y)>=topPos&&parseFloat(y)<=topPos+el}(center_x,center_y,el,margin)||(element=el)}),element}function getMagnetVector(x,y,magnet_x,magnet_y,strength){var[magnet_x,x]=[(magnet_x-x)*strength,(magnet_y-y)*strength];return[magnet_x,x]}var magnet_counter=0;function updateView(fix,blink){let sumX=0,sumY=0;for(const position of dot.history)sumX+=position.x,sumY+=position.y;array=dot.history,elapsed_time=array[array.length-1].time.getTime()-array[0].time.getTime(),dist_x=array[array.length-1].x-array[0].x,array=array[array.length-1].y-array[0].y;var magnet_x,dist_x=Math.sqrt(dist_x*dist_x+array*array)/elapsed_time,array=sumX/dot.history.length,elapsed_time=sumY/dot.history.length,el=scanMagnet(array,elapsed_time,magnetStrong,dot.margin);null!=el&&dist_x<velocity_thresh?(dist_x=1,null==currentElement.el?(currentElement.el=el,magnet_counter=0):dot.margin<5&&(currentElement.frame+=1,20<currentElement.frame&&(dist_x=0),onMagnetCalibration(currentElement.frame/20)),onMagnet(currentElement.el,fix,blink),el=el.getBoundingClientRect(),magnet_x=parseInt(el.left)+parseInt(el.width)/2,el=parseInt(el.top)+parseInt(el.height)/2,[magnet_x,el]=getMagnetVector(dot.x+dot.offset_x,dot.y+dot.offset_y,magnet_x,el,magnetStrong*dist_x),dot.offset_x+=magnet_x,dot.offset_y+=el,10<magnet_counter&&([magnet_x,el]=getMagnetVector(dot.x+dot.offset_x,dot.y+dot.offset_y,dot.x,dot.y,-.01*dist_x),dot.offset_x-=magnet_x,dot.offset_y-=el,dot.offset_ret_x+=magnet_x,dot.offset_ret_y+=el,dot.margin=function(diff_x,diff_y){diff_x=Math.sqrt(diff_x*diff_x+diff_y*diff_y);if(diff_x>magnetAssistanceRange)return magnetAssistanceRange;return diff_x}(magnet_x,el),setOffset(dot.offset_ret_x,dot.offset_ret_y)),magnet_counter+=1,onCursor(array,elapsed_time,fix,blink)):(currentElement.el=null,currentElement.frame=0,dist_x=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,magnet_x=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,(dot.x+dot.offset_x<0||dot.x+dot.offset_x>dist_x||dot.y+dot.offset_y<0||dot.y+dot.offset_y>magnet_x)&&(dot.offset_x=0,dot.offset_y=0,dot.offset_ret_x=0,dot.offset_ret_y=0),onCursor(dot.x+dot.offset_x,dot.y+dot.offset_y,fix,blink))}function moveDot(x,y,fix,blink){!function(x,y){dot.x=x,dot.y=y,dot.history.push({x:dot.x+dot.offset_x,y:dot.y+dot.offset_y,time:new Date}),10<dot.history.length&&dot.history.shift()}(x,y),updateView(fix,blink)}var calibrated=!1;EyeGestureApi(API_KEY,thresh,radius,{onFrame:onFrame,onCursor:function(x,y,fix,blink){eyeMagnetRun&&(calibrated?moveDot:onCursor)(x,y,fix,blink)},onCalibration:function(){calibrated=!0,onCalibration()},onWeakConnection:onWeakConnection,calibration:calibration,calibration_layout:calibration_layout,display_width:display_width,display_height:display_height,DEBUG:DEBUG})}